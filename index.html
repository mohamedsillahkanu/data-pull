<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIV Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow-x: hidden !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
            color: #e0e7ff;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(30, 58, 138, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 16px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .logo-box {
            width: 120px;
            height: 120px;
            background: rgba(30, 64, 175, 0.4);
            border: 2px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .logo-box:hover {
            border-color: #60a5fa;
            background: rgba(59, 130, 246, 0.3);
            transform: scale(1.05);
        }

        .logo-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .login-header p {
            color: #bfdbfe;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #bfdbfe;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(30, 64, 175, 0.4);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(30, 64, 175, 0.6);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .form-input::placeholder {
            color: #93c5fd;
        }

        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .required {
            color: #93c5fd;
        }

        .dashboard-content {
            display: none;
            min-height: 100vh;
            background: transparent;
        }

        .dashboard-content.show {
            display: block;
        }

        .dashboard-header {
            background: rgba(30, 58, 138, 0.6);
            backdrop-filter: blur(10px);
            padding: 25px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 16px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 32px;
            color: #ffffff;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .current-date {
            color: #bfdbfe;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .last-updated {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
        }

        .last-updated .label {
            color: #bfdbfe;
            margin-right: 5px;
        }

        .last-updated .time {
            color: #ffffff;
            font-weight: 600;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logout-btn {
            background: rgba(30, 64, 175, 0.4);
            color: #bfdbfe;
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            border-color: #60a5fa;
            background: rgba(30, 64, 175, 0.6);
            color: #ffffff;
        }

        .filters-card {
            background: rgba(30, 58, 138, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }

        .filters-header h2 {
            font-size: 20px;
            color: #ffffff;
            font-weight: 700;
        }

        .reset-filters-btn {
            padding: 8px 16px;
            background: rgba(30, 64, 175, 0.4);
            color: #bfdbfe;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reset-filters-btn:hover {
            background: rgba(30, 64, 175, 0.6);
            color: #ffffff;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #bfdbfe;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(30, 64, 175, 0.4);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .filter-select:focus {
            outline: none;
            border-color: #60a5fa;
            background: rgba(30, 64, 175, 0.6);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        .filter-select option {
            background: #1e3a8a;
            color: #ffffff;
        }

        .apply-filters-btn {
            width: 100%;
            padding: 14px 24px;
            background: #4a7c9e;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(74, 124, 158, 0.3);
        }

        .apply-filters-btn:hover {
            background: #3d6580;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 124, 158, 0.4);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(30, 58, 138, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 28px rgba(59, 130, 246, 0.3);
            border-color: rgba(96, 165, 250, 0.5);
        }

        .metric-card.blue { border-left: 4px solid #3b82f6; }
        .metric-card.green { border-left: 4px solid #10b981; }
        .metric-card.red { border-left: 4px solid #ef4444; }
        .metric-card.yellow { border-left: 4px solid #fbbf24; }
        .metric-card.purple { border-left: 4px solid #a78bfa; }
        .metric-card.teal { border-left: 4px solid #06b6d4; }

        .card-icon {
            font-size: 48px;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
        }

        .card-title {
            font-size: 14px;
            color: #bfdbfe;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-value {
            font-size: 36px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .card-subtitle {
            font-size: 12px;
            color: #93c5fd;
        }

        .dashboard-card {
            background: rgba(30, 58, 138, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
        }

        .card-header h2 {
            font-size: 20px;
            color: #ffffff;
            font-weight: 700;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.2);
            color: #bfdbfe;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: rgba(59, 130, 246, 0.4);
            color: #ffffff;
            border-color: #60a5fa;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table thead {
            background: rgba(30, 64, 175, 0.5);
        }

        .data-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #bfdbfe;
            border-bottom: 2px solid rgba(96, 165, 250, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.1);
            color: #e0e7ff;
        }

        .data-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .loading-cell {
            text-align: center;
            color: #93c5fd;
            padding: 40px !important;
        }

        .positive-cell { color: #ef4444; font-weight: 600; }
        .negative-cell { color: #10b981; font-weight: 600; }
        .inconclusive-cell { color: #fbbf24; font-weight: 600; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            padding: 20px 0;
        }

        .activity-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px 15px;
            border-left: 3px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            gap: 15px;
        }

        .activity-time {
            color: #60a5fa;
            font-weight: 600;
            font-size: 13px;
        }

        .activity-text {
            color: #bfdbfe;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(30, 58, 138, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(96, 165, 250, 0.3);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: none;
            z-index: 3000;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
            color: #e0e7ff;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #ef4444;
        }

        .notification.info {
            border-left: 4px solid #60a5fa;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                width: 100%;
                flex-wrap: wrap;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .logout-btn, .refresh-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo-box">
                    <img src="NMCP.png" alt="NMCP Logo" class="logo-img" onerror="this.style.display='none'">
                </div>
                <div class="logo-box">
                    <img src="ICF-SL.jpg" alt="ICF-SL Logo" class="logo-img" onerror="this.style.display='none'">
                </div>
            </div>

            <div class="login-header">
                <h1>🏥 HIV Testing Dashboard</h1>
                <p>Real-time Data Monitoring & Analytics</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">DHIS2 Instance URL <span class="required">*</span></label>
                    <input type="url" class="form-input" id="instanceUrl" placeholder="https://your-instance.dhis2.org" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Username <span class="required">*</span></label>
                    <input type="text" class="form-input" id="username" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Password <span class="required">*</span></label>
                    <input type="password" class="form-input" id="password" required>
                </div>

                <button type="submit" class="btn-primary">Connect to Dashboard</button>
            </form>
        </div>
    </div>

    <div class="dashboard-content" id="dashboardContent">
        <div class="container">
            <div class="dashboard-header">
                <div class="header-left">
                    <h1>🏥 HIV Testing Survey Dashboard</h1>
                    <p class="current-date" id="currentDate"></p>
                </div>
                <div class="header-right">
                    <div class="last-updated">
                        <span class="label">Last Updated:</span>
                        <span class="time" id="lastUpdated">--:--:--</span>
                    </div>
                    <button class="refresh-btn" id="refreshBtn" onclick="applyFilters()">
                        <span class="refresh-icon">🔄</span> Refresh
                    </button>
                    <button class="logout-btn" id="logoutBtn">Logout</button>
                </div>
            </div>

            <div class="filters-card">
                <div class="filters-header">
                    <h2>🔍 Filters</h2>
                    <button class="reset-filters-btn" onclick="resetFilters()">↺ Reset All</button>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Year</label>
                        <select class="filter-select" id="yearFilter">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Month</label>
                        <select class="filter-select" id="monthFilter">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>

                    <div class="filter-group" id="level1Group" style="display: none;">
                        <label class="filter-label" id="level1Label">Level 1</label>
                        <select class="filter-select" id="level1Filter" onchange="handleLevel1Change()">
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div class="filter-group" id="level2Group" style="display: none;">
                        <label class="filter-label" id="level2Label">Level 2</label>
                        <select class="filter-select" id="level2Filter" onchange="handleLevel2Change()">
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div class="filter-group" id="level3Group" style="display: none;">
                        <label class="filter-label" id="level3Label">Level 3</label>
                        <select class="filter-select" id="level3Filter" onchange="handleLevel3Change()">
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div class="filter-group" id="level4Group" style="display: none;">
                        <label class="filter-label" id="level4Label">Level 4</label>
                        <select class="filter-select" id="level4Filter" onchange="applyFilters()">
                            <option value="all">All</option>
                        </select>
                    </div>

                    <div class="filter-group" style="display: flex; align-items: flex-end;">
                        <button class="apply-filters-btn" onclick="applyFilters()">
                            ✓ Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="metric-card blue">
                    <div class="card-icon">👥</div>
                    <div class="card-content">
                        <h3 class="card-title">Clients Tested</h3>
                        <div class="card-value" id="totalTested">--</div>
                        <div class="card-subtitle">Total clients tested for HIV</div>
                    </div>
                </div>

                <div class="metric-card green">
                    <div class="card-icon">✅</div>
                    <div class="card-content">
                        <h3 class="card-title">Negative Results</h3>
                        <div class="card-value" id="negativeCount">--</div>
                        <div class="card-subtitle">HIV Negative tests</div>
                    </div>
                </div>

                <div class="metric-card red">
                    <div class="card-icon">⚠️</div>
                    <div class="card-content">
                        <h3 class="card-title">Positive Results</h3>
                        <div class="card-value" id="positiveCount">--</div>
                        <div class="card-subtitle">HIV Positive tests</div>
                    </div>
                </div>

                <div class="metric-card yellow">
                    <div class="card-icon">❓</div>
                    <div class="card-content">
                        <h3 class="card-title">Inconclusive</h3>
                        <div class="card-value" id="inconclusiveCount">--</div>
                        <div class="card-subtitle">Inconclusive results</div>
                    </div>
                </div>

                <div class="metric-card purple">
                    <div class="card-icon">👤</div>
                    <div class="card-content">
                        <h3 class="card-title">Average Age</h3>
                        <div class="card-value" id="avgAge">--</div>
                        <div class="card-subtitle">Client average age</div>
                    </div>
                </div>

                <div class="metric-card teal">
                    <div class="card-icon">💬</div>
                    <div class="card-content">
                        <h3 class="card-title">Counseling Sessions</h3>
                        <div class="card-value" id="counselingTotal">--</div>
                        <div class="card-subtitle">Total counseling provided</div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>📊 Test Results Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="resultsChart"></canvas>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>💬 Counseling Types</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="counselingChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2>📋 Detailed Data by Organisation Unit</h2>
                    <div class="card-actions">
                        <button class="action-btn" onclick="exportTableToCSV()">
                            📥 Export CSV
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Organisation Unit</th>
                                <th>Period</th>
                                <th>Clients Tested</th>
                                <th>Positive</th>
                                <th>Negative</th>
                                <th>Inconclusive</th>
                                <th>Avg Age</th>
                                <th>Counseling</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="8" class="loading-cell">Apply filters to load data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2>📈 Monthly Trend Analysis</h2>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2>📝 Activity Log</h2>
                </div>
                <div class="activity-log" id="activityLog">
                    <div class="activity-item">
                        <span class="activity-time">--:--:--</span>
                        <span class="activity-text">Ready to load data. Apply filters to begin.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const DATA_ELEMENTS = {
            clientsTested: 'kLmN8oPqR3s',
            testResult: 'WvYDK6cYopD',
            clientAge: 'tUvW9xYzA1b',
            counselingType: 'Oj5wqLKQ6f3',
            comments: 'cDeFgH2iJ4k'
        };

        const OPTIONS = {
            positive: 'uVGKdrp4iYw',
            negative: 'RxqYKri1WqY',
            inconclusive: 'tOaQYVdAs6D',
            individual: 'qjrA54Rvhrl',
            group: 'lTRsgvyDd5M',
            couples: 'RUGObX8DV5L'
        };

        const state = { 
            config: null, 
            isLoggedIn: false,
            orgUnits: [],
            charts: {},
            currentData: [],
            hierarchyMaps: {
                level1_level2: {},
                level2_level3: {},
                level3_level4: {}
            },
            levelFields: { level1: null, level2: null, level3: null, level4: null }
        };

        async function fetchWithAuth(url, options = {}) {
            if (!state.config) throw new Error('Not authenticated');
            const authHeader = 'Basic ' + btoa(`${state.config.username}:${state.config.password}`);
            return fetch(url, { 
                ...options, 
                headers: { 
                    'Authorization': authHeader, 
                    'Content-Type': 'application/json', 
                    ...options.headers 
                },
                mode: 'cors'
            });
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function updateCurrentDate() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = today.toLocaleDateString('en-US', options);
            }
        }

        function updateLastUpdated() {
            const timeElement = document.getElementById('lastUpdated');
            if (timeElement) timeElement.textContent = new Date().toLocaleTimeString();
        }

        function addActivityLog(message) {
            const logContainer = document.getElementById('activityLog');
            if (!logContainer) return;
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            const time = document.createElement('span');
            time.className = 'activity-time';
            time.textContent = new Date().toLocaleTimeString();
            const text = document.createElement('span');
            text.className = 'activity-text';
            text.textContent = message;
            activityItem.appendChild(time);
            activityItem.appendChild(text);
            if (logContainer.firstChild) {
                logContainer.insertBefore(activityItem, logContainer.firstChild);
            } else {
                logContainer.appendChild(activityItem);
            }
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        async function loadOrganisationUnits() {
            try {
                addActivityLog('Loading organisation units...');
                const url = `${state.config.instanceUrl}/api/organisationUnits.json?fields=id,displayName,level,parent[id]&paging=false`;
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to fetch organisation units');
                const data = await response.json();
                state.orgUnits = data.organisationUnits || [];
                
                detectHierarchy();
                populateHierarchyFilters();
                
                addActivityLog(`Loaded ${state.orgUnits.length} organisation units`);
            } catch (error) {
                console.error('Error loading org units:', error);
                addActivityLog(`Error loading org units: ${error.message}`);
            }
        }

        function detectHierarchy() {
            const levels = {};
            
            state.orgUnits.forEach(ou => {
                const level = ou.level;
                if (!levels[level]) levels[level] = [];
                levels[level].push(ou);
            });
            
            const sortedLevels = Object.keys(levels).sort((a, b) => a - b);
            
            if (sortedLevels.length >= 4) {
                state.levelFields.level1 = sortedLevels[0];
                state.levelFields.level2 = sortedLevels[1];
                state.levelFields.level3 = sortedLevels[2];
                state.levelFields.level4 = sortedLevels[3];
            } else if (sortedLevels.length === 3) {
                state.levelFields.level1 = sortedLevels[0];
                state.levelFields.level2 = sortedLevels[1];
                state.levelFields.level3 = sortedLevels[2];
            } else if (sortedLevels.length === 2) {
                state.levelFields.level1 = sortedLevels[0];
                state.levelFields.level2 = sortedLevels[1];
            }
            
            state.orgUnits.forEach(ou => {
                if (ou.parent && ou.parent.id) {
                    const parent = state.orgUnits.find(p => p.id === ou.parent.id);
                    if (parent) {
                        if (parent.level == state.levelFields.level1 && ou.level == state.levelFields.level2) {
                            if (!state.hierarchyMaps.level1_level2[parent.id]) {
                                state.hierarchyMaps.level1_level2[parent.id] = new Set();
                            }
                            state.hierarchyMaps.level1_level2[parent.id].add(ou.id);
                        }
                        
                        if (parent.level == state.levelFields.level2 && ou.level == state.levelFields.level3) {
                            if (!state.hierarchyMaps.level2_level3[parent.id]) {
                                state.hierarchyMaps.level2_level3[parent.id] = new Set();
                            }
                            state.hierarchyMaps.level2_level3[parent.id].add(ou.id);
                        }
                        
                        if (parent.level == state.levelFields.level3 && ou.level == state.levelFields.level4) {
                            if (!state.hierarchyMaps.level3_level4[parent.id]) {
                                state.hierarchyMaps.level3_level4[parent.id] = new Set();
                            }
                            state.hierarchyMaps.level3_level4[parent.id].add(ou.id);
                        }
                    }
                }
            });
        }

        function populateHierarchyFilters() {
            if (state.levelFields.level1) {
                const level1Units = state.orgUnits.filter(ou => ou.level == state.levelFields.level1);
                const level1Filter = document.getElementById('level1Filter');
                level1Units.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level1Filter.appendChild(option);
                });
                document.getElementById('level1Group').style.display = 'block';
                document.getElementById('level1Label').textContent = `Level ${state.levelFields.level1}`;
            }
            
            if (state.levelFields.level2) {
                document.getElementById('level2Group').style.display = 'block';
                document.getElementById('level2Label').textContent = `Level ${state.levelFields.level2}`;
            }
            
            if (state.levelFields.level3) {
                document.getElementById('level3Group').style.display = 'block';
                document.getElementById('level3Label').textContent = `Level ${state.levelFields.level3}`;
            }
            
            if (state.levelFields.level4) {
                document.getElementById('level4Group').style.display = 'block';
                document.getElementById('level4Label').textContent = `Level ${state.levelFields.level4}`;
            }
        }

        function handleLevel1Change() {
            const selectedLevel1 = document.getElementById('level1Filter').value;
            const level2Filter = document.getElementById('level2Filter');
            const level3Filter = document.getElementById('level3Filter');
            const level4Filter = document.getElementById('level4Filter');
            
            level2Filter.innerHTML = '<option value="all">All</option>';
            level3Filter.innerHTML = '<option value="all">All</option>';
            level4Filter.innerHTML = '<option value="all">All</option>';
            
            if (selectedLevel1 !== 'all' && state.hierarchyMaps.level1_level2[selectedLevel1]) {
                const childIds = Array.from(state.hierarchyMaps.level1_level2[selectedLevel1]);
                const children = state.orgUnits.filter(ou => childIds.includes(ou.id)).sort((a, b) => a.displayName.localeCompare(b.displayName));
                children.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level2Filter.appendChild(option);
                });
            } else if (selectedLevel1 === 'all' && state.levelFields.level2) {
                const level2Units = state.orgUnits.filter(ou => ou.level == state.levelFields.level2).sort((a, b) => a.displayName.localeCompare(b.displayName));
                level2Units.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level2Filter.appendChild(option);
                });
            }
            
            applyFilters();
        }

        function handleLevel2Change() {
            const selectedLevel2 = document.getElementById('level2Filter').value;
            const level3Filter = document.getElementById('level3Filter');
            const level4Filter = document.getElementById('level4Filter');
            
            level3Filter.innerHTML = '<option value="all">All</option>';
            level4Filter.innerHTML = '<option value="all">All</option>';
            
            if (selectedLevel2 !== 'all' && state.hierarchyMaps.level2_level3[selectedLevel2]) {
                const childIds = Array.from(state.hierarchyMaps.level2_level3[selectedLevel2]);
                const children = state.orgUnits.filter(ou => childIds.includes(ou.id)).sort((a, b) => a.displayName.localeCompare(b.displayName));
                children.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level3Filter.appendChild(option);
                });
            } else if (selectedLevel2 === 'all' && state.levelFields.level3) {
                const level3Units = state.orgUnits.filter(ou => ou.level == state.levelFields.level3).sort((a, b) => a.displayName.localeCompare(b.displayName));
                level3Units.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level3Filter.appendChild(option);
                });
            }
            
            applyFilters();
        }

        function handleLevel3Change() {
            const selectedLevel3 = document.getElementById('level3Filter').value;
            const level4Filter = document.getElementById('level4Filter');
            
            level4Filter.innerHTML = '<option value="all">All</option>';
            
            if (selectedLevel3 !== 'all' && state.hierarchyMaps.level3_level4[selectedLevel3]) {
                const childIds = Array.from(state.hierarchyMaps.level3_level4[selectedLevel3]);
                const children = state.orgUnits.filter(ou => childIds.includes(ou.id)).sort((a, b) => a.displayName.localeCompare(b.displayName));
                children.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level4Filter.appendChild(option);
                });
            } else if (selectedLevel3 === 'all' && state.levelFields.level4) {
                const level4Units = state.orgUnits.filter(ou => ou.level == state.levelFields.level4).sort((a, b) => a.displayName.localeCompare(b.displayName));
                level4Units.forEach(ou => {
                    const option = document.createElement('option');
                    option.value = ou.id;
                    option.textContent = ou.displayName;
                    level4Filter.appendChild(option);
                });
            }
            
            applyFilters();
        }

        function getSelectedOrgUnits() {
            const level1 = document.getElementById('level1Filter').value;
            const level2 = document.getElementById('level2Filter').value;
            const level3 = document.getElementById('level3Filter').value;
            const level4 = document.getElementById('level4Filter').value;
            
            let selectedUnits = [];
            
            if (level4 !== 'all') {
                selectedUnits = [level4];
            } else if (level3 !== 'all') {
                const children = state.orgUnits.filter(ou => ou.level == state.levelFields.level4 && ou.parent && ou.parent.id === level3);
                selectedUnits = children.length > 0 ? children.map(ou => ou.id) : [level3];
            } else if (level2 !== 'all') {
                const children = state.orgUnits.filter(ou => ou.level == state.levelFields.level3 && ou.parent && ou.parent.id === level2);
                selectedUnits = children.length > 0 ? children.map(ou => ou.id) : [level2];
            } else if (level1 !== 'all') {
                const children = state.orgUnits.filter(ou => ou.level == state.levelFields.level2 && ou.parent && ou.parent.id === level1);
                selectedUnits = children.length > 0 ? children.map(ou => ou.id) : [level1];
            } else {
                selectedUnits = state.orgUnits.map(ou => ou.id);
            }
            
            return selectedUnits;
        }

        function getPeriodFromFilters() {
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value;
            if (month) {
                return `${year}${month}`;
            } else {
                const periods = [];
                for (let m = 1; m <= 12; m++) {
                    const monthStr = String(m).padStart(2, '0');
                    periods.push(`${year}${monthStr}`);
                }
                return periods;
            }
        }

        async function applyFilters() {
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.classList.add('loading');
                refreshBtn.disabled = true;
            }
            try {
                addActivityLog('Applying filters and fetching data...');
                const orgUnits = getSelectedOrgUnits();
                const periods = getPeriodFromFilters();
                if (orgUnits.length === 0) {
                    showNotification('Please select at least one organisation unit', 'error');
                    return;
                }
                const dataElementIds = Object.values(DATA_ELEMENTS).join(',');
                const orgUnitIds = orgUnits.join(',');
                let allDataValues = [];
                if (Array.isArray(periods)) {
                    addActivityLog(`Fetching data for ${periods.length} months...`);
                    for (const period of periods) {
                        const url = `${state.config.instanceUrl}/api/dataValueSets.json?dataElement=${dataElementIds}&orgUnit=${orgUnitIds}&period=${period}`;
                        const response = await fetchWithAuth(url);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.dataValues) {
                                allDataValues = allDataValues.concat(data.dataValues);
                            }
                        }
                    }
                } else {
                    const url = `${state.config.instanceUrl}/api/dataValueSets.json?dataElement=${dataElementIds}&orgUnit=${orgUnitIds}&period=${periods}`;
                    const response = await fetchWithAuth(url);
                    if (!response.ok) throw new Error(`Failed to fetch data: ${response.status}`);
                    const data = await response.json();
                    allDataValues = data.dataValues || [];
                }
                state.currentData = allDataValues;
                processDataValues(allDataValues);
                updateLastUpdated();
                addActivityLog(`Successfully loaded ${allDataValues.length} data values`);
                showNotification('Data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error fetching data:', error);
                addActivityLog(`Error: ${error.message}`);
                showNotification(`Failed to fetch data: ${error.message}`, 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.classList.remove('loading');
                    refreshBtn.disabled = false;
                }
            }
        }

        function resetFilters() {
            const currentYear = new Date().getFullYear();
            document.getElementById('yearFilter').value = currentYear;
            document.getElementById('monthFilter').value = '';
            document.getElementById('level1Filter').value = 'all';
            document.getElementById('level2Filter').innerHTML = '<option value="all">All</option>';
            document.getElementById('level3Filter').innerHTML = '<option value="all">All</option>';
            document.getElementById('level4Filter').innerHTML = '<option value="all">All</option>';
            
            handleLevel1Change();
            showNotification('Filters reset', 'info');
        }

        function processDataValues(dataValues) {
            const grouped = {};
            let totalTested = 0, positiveCount = 0, negativeCount = 0, inconclusiveCount = 0;
            let ageSum = 0, ageCount = 0, counselingCount = 0;
            const counselingTypes = { individual: 0, group: 0, couples: 0 };
            
            dataValues.forEach(dv => {
                const key = `${dv.orgUnit}_${dv.period}`;
                if (!grouped[key]) {
                    grouped[key] = { orgUnit: dv.orgUnit, period: dv.period, clientsTested: 0, positive: 0, negative: 0, inconclusive: 0, ages: [], counseling: [] };
                }
                if (dv.dataElement === DATA_ELEMENTS.clientsTested) {
                    const count = parseInt(dv.value) || 0;
                    grouped[key].clientsTested += count;
                    totalTested += count;
                }
                if (dv.dataElement === DATA_ELEMENTS.testResult) {
                    if (dv.value === OPTIONS.positive) { grouped[key].positive++; positiveCount++; }
                    else if (dv.value === OPTIONS.negative) { grouped[key].negative++; negativeCount++; }
                    else if (dv.value === OPTIONS.inconclusive) { grouped[key].inconclusive++; inconclusiveCount++; }
                }
                if (dv.dataElement === DATA_ELEMENTS.clientAge) {
                    const age = parseInt(dv.value);
                    if (!isNaN(age)) { grouped[key].ages.push(age); ageSum += age; ageCount++; }
                }
                if (dv.dataElement === DATA_ELEMENTS.counselingType) {
                    counselingCount++;
                    grouped[key].counseling.push(dv.value);
                    if (dv.value === OPTIONS.individual) counselingTypes.individual++;
                    else if (dv.value === OPTIONS.group) counselingTypes.group++;
                    else if (dv.value === OPTIONS.couples) counselingTypes.couples++;
                }
            });
            
            document.getElementById('totalTested').textContent = totalTested.toLocaleString();
            document.getElementById('positiveCount').textContent = positiveCount.toLocaleString();
            document.getElementById('negativeCount').textContent = negativeCount.toLocaleString();
            document.getElementById('inconclusiveCount').textContent = inconclusiveCount.toLocaleString();
            document.getElementById('avgAge').textContent = ageCount > 0 ? Math.round(ageSum / ageCount) : '--';
            document.getElementById('counselingTotal').textContent = counselingCount.toLocaleString();
            
            updateDataTable(grouped);
            updateResultsChart(positiveCount, negativeCount, inconclusiveCount);
            updateCounselingChart(counselingTypes);
            updateTrendChart(grouped);
        }

        async function updateDataTable(grouped) {
            const tableBody = document.getElementById('tableBody');
            if (!tableBody) return;
            const orgUnitIds = [...new Set(Object.values(grouped).map(g => g.orgUnit))];
            const orgUnitNames = await fetchOrgUnitNames(orgUnitIds);
            tableBody.innerHTML = '';
            if (Object.keys(grouped).length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" class="loading-cell">No data available for selected filters</td>';
                tableBody.appendChild(row);
                return;
            }
            Object.values(grouped).forEach(data => {
                const row = document.createElement('tr');
                const avgAge = data.ages.length > 0 ? Math.round(data.ages.reduce((a, b) => a + b, 0) / data.ages.length) : '--';
                row.innerHTML = `<td>${orgUnitNames[data.orgUnit] || data.orgUnit}</td><td>${formatPeriod(data.period)}</td><td>${data.clientsTested}</td><td class="positive-cell">${data.positive}</td><td class="negative-cell">${data.negative}</td><td class="inconclusive-cell">${data.inconclusive}</td><td>${avgAge}</td><td>${data.counseling.length}</td>`;
                tableBody.appendChild(row);
            });
        }

        async function fetchOrgUnitNames(orgUnitIds) {
            if (orgUnitIds.length === 0) return {};
            try {
                const url = `${state.config.instanceUrl}/api/organisationUnits.json?filter=id:in:[${orgUnitIds.join(',')}]&fields=id,displayName&paging=false`;
                const response = await fetchWithAuth(url);
                if (response.ok) {
                    const data = await response.json();
                    const names = {};
                    data.organisationUnits.forEach(ou => { names[ou.id] = ou.displayName; });
                    return names;
                }
            } catch (error) {
                console.error('Error fetching org unit names:', error);
            }
            return {};
        }

        function formatPeriod(period) {
            const year = period.substring(0, 4);
            const month = period.substring(4, 6);
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function updateResultsChart(positive, negative, inconclusive) {
            const ctx = document.getElementById('resultsChart');
            if (!ctx) return;
            if (state.charts.results) state.charts.results.destroy();
            state.charts.results = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Inconclusive'],
                    datasets: [{ 
                        data: [positive, negative, inconclusive], 
                        backgroundColor: ['#ef4444', '#10b981', '#fbbf24'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#bfdbfe', padding: 15, font: { size: 13 } }
                        } 
                    } 
                }
            });
        }

        function updateCounselingChart(counselingTypes) {
            const ctx = document.getElementById('counselingChart');
            if (!ctx) return;
            if (state.charts.counseling) state.charts.counseling.destroy();
            state.charts.counseling = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Individual', 'Group', 'Couples'],
                    datasets: [{ 
                        label: 'Sessions', 
                        data: [counselingTypes.individual, counselingTypes.group, counselingTypes.couples], 
                        backgroundColor: ['#3b82f6', '#60a5fa', '#93c5fd'],
                        borderWidth: 0
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false } 
                    }, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#bfdbfe' },
                            grid: { color: 'rgba(191, 219, 254, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#bfdbfe' },
                            grid: { display: false }
                        }
                    } 
                }
            });
        }

        function updateTrendChart(grouped) {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            if (state.charts.trend) state.charts.trend.destroy();
            const periodData = {};
            Object.values(grouped).forEach(data => {
                if (!periodData[data.period]) periodData[data.period] = { tested: 0, positive: 0, negative: 0 };
                periodData[data.period].tested += data.clientsTested;
                periodData[data.period].positive += data.positive;
                periodData[data.period].negative += data.negative;
            });
            const periods = Object.keys(periodData).sort();
            const labels = periods.map(p => formatPeriod(p));
            const testedData = periods.map(p => periodData[p].tested);
            const positiveData = periods.map(p => periodData[p].positive);
            const negativeData = periods.map(p => periodData[p].negative);
            state.charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: 'Clients Tested', 
                            data: testedData, 
                            borderColor: '#3b82f6', 
                            backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                            borderWidth: 3, 
                            tension: 0.4,
                            fill: true
                        },
                        { 
                            label: 'Positive Results', 
                            data: positiveData, 
                            borderColor: '#ef4444', 
                            backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                            borderWidth: 3, 
                            tension: 0.4,
                            fill: true
                        },
                        { 
                            label: 'Negative Results', 
                            data: negativeData, 
                            borderColor: '#10b981', 
                            backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                            borderWidth: 3, 
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { color: '#bfdbfe', font: { size: 13 } }
                        } 
                    }, 
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#bfdbfe' },
                            grid: { color: 'rgba(191, 219, 254, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#bfdbfe' },
                            grid: { display: false }
                        }
                    } 
                }
            });
        }

        function exportTableToCSV() {
            const table = document.getElementById('dataTable');
            if (!table) return;
            let csv = [];
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const csvRow = [];
                cols.forEach(col => { csvRow.push('"' + col.textContent.replace(/"/g, '""') + '"'); });
                csv.push(csvRow.join(','));
            });
            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const year = document.getElementById('yearFilter').value;
            const month = document.getElementById('monthFilter').value || 'all';
            link.download = `hiv-testing-data-${year}-${month}-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            showNotification('Data exported successfully!', 'success');
            addActivityLog('Data exported to CSV');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const instanceUrl = document.getElementById('instanceUrl').value.trim().replace(/\/$/, '');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!instanceUrl.startsWith('http://') && !instanceUrl.startsWith('https://')) {
                showNotification('URL must start with http:// or https://', 'error');
                return;
            }
            const submitBtn = e.target.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Connecting...';
            const config = { instanceUrl, username, password };
            try {
                showNotification('Connecting to DHIS2...', 'info');
                const testUrl = `${instanceUrl}/api/me`;
                const authHeader = 'Basic ' + btoa(`${username}:${password}`);
                const response = await fetch(testUrl, { 
                    method: 'GET', 
                    headers: { 'Authorization': authHeader },
                    mode: 'cors'
                });
                if (response.ok) {
                    const userData = await response.json();
                    state.config = config;
                    state.isLoggedIn = true;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboardContent').classList.add('show');
                    const firstName = userData.firstName || '';
                    const surname = userData.surname || '';
                    const fullName = `${firstName} ${surname}`.trim() || 'User';
                    showNotification(`✅ Connected successfully! Welcome ${fullName}`, 'success');
                    updateCurrentDate();
                    loadOrganisationUnits();
                    const currentYear = new Date().getFullYear();
                    document.getElementById('yearFilter').value = currentYear;
                } else if (response.status === 401) {
                    showNotification('❌ Invalid username or password', 'error');
                } else if (response.status === 403) {
                    showNotification('❌ Access forbidden', 'error');
                } else {
                    showNotification(`Authentication failed (${response.status})`, 'error');
                }
            } catch (error) {
                showNotification(`Connection failed: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Connect to Dashboard';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            state.config = null;
            state.isLoggedIn = false;
            document.getElementById('dashboardContent').classList.remove('show');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginForm').reset();
            showNotification('Logged out successfully', 'info');
        });

        setInterval(updateCurrentDate, 60000);
    </script>
</body>
</html>
