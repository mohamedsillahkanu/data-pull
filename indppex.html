<!DOCTYPE html>   
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HIV Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            height: 100% !important;
            overflow-x: hidden !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #2c6693 0%, #1f4a6a 100%);
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: #ffffff;
            border: 1px solid #e3f2fd;
            border-radius: 12px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .logo-box {
            width: 120px;
            height: 120px;
            background: #f5f5f5;
            border: 2px solid #e3f2fd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .logo-box:hover {
            border-color: #2c6693;
            background: #e3f2fd;
            transform: scale(1.05);
        }

        .logo-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #2c6693;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: #ffffff;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            color: #333;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: #2c6693;
            box-shadow: 0 0 0 3px rgba(44, 102, 147, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            background: #2c6693;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1f4a6a;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(44, 102, 147, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .required {
            color: #d32f2f;
        }

        .dashboard-content {
            display: none;
            min-height: 100vh;
            background: #f5f7fa;
        }

        .dashboard-content.show {
            display: block;
        }

        .dashboard-header {
            background: #ffffff;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left h1 {
            font-size: 28px;
            color: #2c6693;
            margin-bottom: 5px;
        }

        .current-date {
            color: #666;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .last-updated {
            background: #e3f2fd;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        .last-updated .label {
            color: #666;
            margin-right: 5px;
        }

        .last-updated .time {
            color: #2c6693;
            font-weight: 600;
        }

        .refresh-btn {
            background: #2c6693;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #1f4a6a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 102, 147, 0.3);
        }

        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .logout-btn {
            background: #ffffff;
            color: #2c6693;
            border: 1px solid #e3f2fd;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            border-color: #2c6693;
            background: #f5f7fa;
        }

        .filters-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .filters-header h2 {
            font-size: 20px;
            color: #2c6693;
            font-weight: 700;
        }

        .reset-filters-btn {
            padding: 8px 16px;
            background: #6e7681;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reset-filters-btn:hover {
            background: #57606a;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .filter-select {
            width: 100%;
            padding: 10px 14px;
            background: #ffffff;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            color: #333;
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .filter-select:focus {
            outline: none;
            border-color: #2c6693;
            box-shadow: 0 0 0 3px rgba(44, 102, 147, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .filter-btn {
            padding: 6px 12px;
            background: #e3f2fd;
            color: #2c6693;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .filter-btn:hover {
            background: #2c6693;
            color: #ffffff;
        }

        .apply-filters-btn {
            width: 100%;
            padding: 12px 24px;
            background: #2c6693;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .apply-filters-btn:hover {
            background: #1f4a6a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(44, 102, 147, 0.3);
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease-out;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .metric-card.blue { border-left: 4px solid #2c6693; }
        .metric-card.green { border-left: 4px solid #2ea043; }
        .metric-card.red { border-left: 4px solid #dc3545; }
        .metric-card.yellow { border-left: 4px solid #ffc107; }
        .metric-card.purple { border-left: 4px solid #6f42c1; }
        .metric-card.teal { border-left: 4px solid #00bcd4; }

        .card-icon {
            font-size: 48px;
            flex-shrink: 0;
        }

        .card-content {
            flex: 1;
        }

        .card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .card-value {
            font-size: 36px;
            font-weight: 700;
            color: #2c6693;
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 12px;
            color: #999;
        }

        .dashboard-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            animation: fadeInUp 0.6s ease-out;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f5f7fa;
        }

        .card-header h2 {
            font-size: 20px;
            color: #2c6693;
            font-weight: 700;
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 16px;
            background: #e3f2fd;
            color: #2c6693;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: #2c6693;
            color: #ffffff;
        }

        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table thead {
            background: #f5f7fa;
        }

        .data-table th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #2c6693;
            border-bottom: 2px solid #e3f2fd;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f5f7fa;
            color: #333;
        }

        .data-table tbody tr:hover {
            background: #f5f7fa;
        }

        .loading-cell {
            text-align: center;
            color: #999;
            padding: 40px !important;
        }

        .positive-cell { color: #dc3545; font-weight: 600; }
        .negative-cell { color: #2ea043; font-weight: 600; }
        .inconclusive-cell { color: #ffc107; font-weight: 600; }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            padding: 20px 0;
        }

        .activity-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px 15px;
            border-left: 3px solid #2c6693;
            background: #f5f7fa;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            gap: 15px;
        }

        .activity-time {
            color: #2c6693;
            font-weight: 600;
            font-size: 13px;
        }

        .activity-text {
            color: #666;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffffff;
            border: 1px solid #e3f2fd;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 3000;
            animation: slideInRight 0.3s ease-out;
            min-width: 300px;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #2ea043;
        }

        .notification.error {
            border-left: 4px solid #d32f2f;
        }

        .notification.info {
            border-left: 4px solid #2c6693;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 1200px) {
            .filters-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-right {
                width: 100%;
                flex-wrap: wrap;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .logout-btn, .refresh-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo-box">
                    <img src="NMCP.png" alt="NMCP Logo" class="logo-img" onerror="this.style.display='none'">
                </div>
                <div class="logo-box">
                    <img src="ICF-SL.jpg" alt="ICF-SL Logo" class="logo-img" onerror="this.style.display='none'">
                </div>
            </div>

            <div class="login-header">
                <h1>üè• HIV Testing Dashboard</h1>
                <p>Real-time Data Monitoring & Analytics</p>
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">DHIS2 Instance URL <span class="required">*</span></label>
                    <input type="url" class="form-input" id="instanceUrl" placeholder="https://your-instance.dhis2.org" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Username <span class="required">*</span></label>
                    <input type="text" class="form-input" id="username" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Password <span class="required">*</span></label>
                    <input type="password" class="form-input" id="password" required>
                </div>

                <button type="submit" class="btn-primary">Connect to Dashboard</button>
            </form>
        </div>
    </div>

    <div class="dashboard-content" id="dashboardContent">
        <div class="dashboard-header">
            <div class="header-left">
                <h1>üè• HIV Testing Survey Dashboard</h1>
                <p class="current-date" id="currentDate"></p>
            </div>
            <div class="header-right">
                <div class="last-updated">
                    <span class="label">Last Updated:</span>
                    <span class="time" id="lastUpdated">--:--:--</span>
                </div>
                <button class="refresh-btn" id="refreshBtn" onclick="applyFilters()">
                    <span class="refresh-icon">üîÑ</span> Refresh
                </button>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <div class="container">
            <div class="filters-card">
                <div class="filters-header">
                    <h2>üîç Filters</h2>
                    <button class="reset-filters-btn" onclick="resetFilters()">‚Ü∫ Reset All</button>
                </div>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">Level 1 (National)</label>
                        <select class="filter-select" id="level1Filter" multiple size="3">
                            <option value="ALL" selected>All Level 1</option>
                        </select>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllLevel(1)">Select All</button>
                            <button class="filter-btn" onclick="clearAllLevel(1)">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Level 2 (Regional)</label>
                        <select class="filter-select" id="level2Filter" multiple size="3">
                            <option value="ALL" selected>All Level 2</option>
                        </select>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllLevel(2)">Select All</button>
                            <button class="filter-btn" onclick="clearAllLevel(2)">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Level 3 (District)</label>
                        <select class="filter-select" id="level3Filter" multiple size="3">
                            <option value="ALL" selected>All Level 3</option>
                        </select>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllLevel(3)">Select All</button>
                            <button class="filter-btn" onclick="clearAllLevel(3)">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Level 4 (Facility)</label>
                        <select class="filter-select" id="level4Filter" multiple size="3">
                            <option value="ALL" selected>All Level 4</option>
                        </select>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllLevel(4)">Select All</button>
                            <button class="filter-btn" onclick="clearAllLevel(4)">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Year</label>
                        <select class="filter-select" id="yearFilter" multiple size="3">
                            <option value="ALL" selected>All Years</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023">2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                        </select>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllYears()">Select All</button>
                            <button class="filter-btn" onclick="clearAllYears()">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Month</label>
                        <select class="filter-select" id="monthFilter" multiple size="3">
                            <option value="ALL" selected>All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                        <div class="filter-actions">
                            <button class="filter-btn" onclick="selectAllMonths()">Select All</button>
                            <button class="filter-btn" onclick="clearAllMonths()">Clear All</button>
                        </div>
                    </div>

                    <div class="filter-group" style="grid-column: 1 / -1;">
                        <button class="apply-filters-btn" onclick="applyFilters()">
                            ‚úì Apply Filters
                        </button>
                    </div>
                </div>
            </div>

            <div class="cards-grid">
                <div class="metric-card blue">
                    <div class="card-icon">üë•</div>
                    <div class="card-content">
                        <h3 class="card-title">Clients Tested</h3>
                        <div class="card-value" id="totalTested">--</div>
                        <div class="card-subtitle">Total clients tested for HIV</div>
                    </div>
                </div>

                <div class="metric-card green">
                    <div class="card-icon">‚úÖ</div>
                    <div class="card-content">
                        <h3 class="card-title">Negative Results</h3>
                        <div class="card-value" id="negativeCount">--</div>
                        <div class="card-subtitle">HIV Negative tests</div>
                    </div>
                </div>

                <div class="metric-card red">
                    <div class="card-icon">‚ö†Ô∏è</div>
                    <div class="card-content">
                        <h3 class="card-title">Positive Results</h3>
                        <div class="card-value" id="positiveCount">--</div>
                        <div class="card-subtitle">HIV Positive tests</div>
                    </div>
                </div>

                <div class="metric-card yellow">
                    <div class="card-icon">‚ùì</div>
                    <div class="card-content">
                        <h3 class="card-title">Inconclusive</h3>
                        <div class="card-value" id="inconclusiveCount">--</div>
                        <div class="card-subtitle">Inconclusive results</div>
                    </div>
                </div>

                <div class="metric-card purple">
                    <div class="card-icon">üë§</div>
                    <div class="card-content">
                        <h3 class="card-title">Average Age</h3>
                        <div class="card-value" id="avgAge">--</div>
                        <div class="card-subtitle">Client average age</div>
                    </div>
                </div>

                <div class="metric-card teal">
                    <div class="card-icon">üí¨</div>
                    <div class="card-content">
                        <h3 class="card-title">Counseling Sessions</h3>
                        <div class="card-value" id="counselingTotal">--</div>
                        <div class="card-subtitle">Total counseling provided</div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>üìä Test Results Distribution</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="resultsChart"></canvas>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>üí¨ Counseling Types</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="counselingChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2>üìã Detailed Data by Organisation Unit</h2>
                    <div class="card-actions">
                        <button class="action-btn" onclick="exportTableToCSV()">
                            üì• Export CSV
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th>Organisation Unit</th>
                                <th>Period</th>
                                <th>Clients Tested</th>
                                <th>Positive</th>
                                <th>Negative</th>
                                <th>Inconclusive</th>
                                <th>Avg Age</th>
                                <th>Counseling</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="8" class="loading-cell">Connecting to dashboard...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2>üìà Monthly Trend Analysis</h2>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="dashboard-card">
                <div class="card-header">
                    <h2>üìù Activity Log</h2>
                </div>
                <div class="activity-log" id="activityLog">
                    <div class="activity-item">
                        <span class="activity-time">--:--:--</span>
                        <span class="activity-text">Ready to load data. Connecting to DHIS2...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const DATA_ELEMENTS = {
            clientsTested: 'kLmN8oPqR3s',
            testResult: 'WvYDK6cYopD',
            clientAge: 'tUvW9xYzA1b',
            counselingType: 'Oj5wqLKQ6f3',
            comments: 'cDeFgH2iJ4k'
        };

        const OPTIONS = {
            positive: 'uVGKdrp4iYw',
            negative: 'RxqYKri1WqY',
            inconclusive: 'tOaQYVdAs6D',
            individual: 'qjrA54Rvhrl',
            group: 'lTRsgvyDd5M',
            couples: 'RUGObX8DV5L'
        };

        const state = { 
            config: null, 
            isLoggedIn: false,
            orgUnits: [],
            orgUnitsByLevel: { 1: [], 2: [], 3: [], 4: [] },
            charts: {},
            currentData: []
        };

        async function fetchWithAuth(url, options = {}) {
            if (!state.config) throw new Error('Not authenticated');
            const authHeader = 'Basic ' + btoa(`${state.config.username}:${state.config.password}`);
            return fetch(url, {
                ...options,
                headers: {
                    'Authorization': authHeader,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function updateCurrentDate() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = today.toLocaleDateString('en-US', options);
            }
        }

        function updateLastUpdated() {
            const timeElement = document.getElementById('lastUpdated');
            if (timeElement) timeElement.textContent = new Date().toLocaleTimeString();
        }

        function addActivityLog(message) {
            const logContainer = document.getElementById('activityLog');
            if (!logContainer) return;
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            const time = document.createElement('span');
            time.className = 'activity-time';
            time.textContent = new Date().toLocaleTimeString();
            const text = document.createElement('span');
            text.className = 'activity-text';
            text.textContent = message;
            activityItem.appendChild(time);
            activityItem.appendChild(text);
            if (logContainer.firstChild) {
                logContainer.insertBefore(activityItem, logContainer.firstChild);
            } else {
                logContainer.appendChild(activityItem);
            }
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        async function loadOrganisationUnits() {
            try {
                addActivityLog('Loading organisation units by level...');
                const url = `${state.config.instanceUrl}/api/organisationUnits.json?fields=id,displayName,level&paging=false`;
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to fetch organisation units');
                const data = await response.json();
                state.orgUnits = data.organisationUnits || [];
                
                state.orgUnitsByLevel = { 1: [], 2: [], 3: [], 4: [] };
                state.orgUnits.forEach(ou => {
                    if (ou.level >= 1 && ou.level <= 4) {
                        state.orgUnitsByLevel[ou.level].push(ou);
                    }
                });
                
                for (let level = 1; level <= 4; level++) {
                    const select = document.getElementById(`level${level}Filter`);
                    select.innerHTML = `<option value="ALL" selected>All Level ${level}</option>`;
                    state.orgUnitsByLevel[level].forEach(ou => {
                        const option = document.createElement('option');
                        option.value = ou.id;
                        option.textContent = ou.displayName;
                        select.appendChild(option);
                    });
                }
                
                addActivityLog(`Loaded ${state.orgUnits.length} organisation units across 4 levels`);
            } catch (error) {
                console.error('Error loading org units:', error);
                addActivityLog(`Error loading org units: ${error.message}`);
            }
        }

        function selectAllLevel(level) {
            const select = document.getElementById(`level${level}Filter`);
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
        }

        function clearAllLevel(level) {
            const select = document.getElementById(`level${level}Filter`);
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
            select.options[0].selected = true;
        }

        function selectAllYears() {
            const select = document.getElementById('yearFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
        }

        function clearAllYears() {
            const select = document.getElementById('yearFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
            select.options[0].selected = true;
        }

        function selectAllMonths() {
            const select = document.getElementById('monthFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = true;
            }
        }

        function clearAllMonths() {
            const select = document.getElementById('monthFilter');
            for (let i = 0; i < select.options.length; i++) {
                select.options[i].selected = false;
            }
            select.options[0].selected = true;
        }

        function getSelectedOrgUnits() {
            let selectedOrgUnits = [];
            
            for (let level = 1; level <= 4; level++) {
                const select = document.getElementById(`level${level}Filter`);
                const selected = Array.from(select.selectedOptions).map(opt => opt.value);
                
                if (selected.includes('ALL')) {
                    selectedOrgUnits = selectedOrgUnits.concat(state.orgUnitsByLevel[level].map(ou => ou.id));
                } else {
                    selectedOrgUnits = selectedOrgUnits.concat(selected.filter(id => id !== 'ALL'));
                }
            }
            
            return [...new Set(selectedOrgUnits)];
        }

        function getPeriodFromFilters() {
            const yearSelect = document.getElementById('yearFilter');
            const monthSelect = document.getElementById('monthFilter');
            
            const selectedYears = Array.from(yearSelect.selectedOptions).map(opt => opt.value);
            const selectedMonths = Array.from(monthSelect.selectedOptions).map(opt => opt.value);
            
            let years = selectedYears.includes('ALL') ? ['2025', '2024', '2023', '2022', '2021', '2020'] : selectedYears.filter(y => y !== 'ALL');
            let months = selectedMonths.includes('ALL') ? ['01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'] : selectedMonths.filter(m => m !== 'ALL');
            
            const periods = [];
            years.forEach(year => {
                months.forEach(month => {
                    periods.push(`${year}${month}`);
                });
            });
            
            return periods;
        }

        async function applyFilters() {
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.classList.add('loading');
                refreshBtn.disabled = true;
            }
            try {
                addActivityLog('Applying filters and fetching data...');
                const orgUnits = getSelectedOrgUnits();
                const periods = getPeriodFromFilters();
                if (orgUnits.length === 0) {
                    showNotification('Please select at least one organisation unit', 'error');
                    return;
                }
                const dataElementIds = Object.values(DATA_ELEMENTS).join(',');
                const orgUnitIds = orgUnits.join(',');
                let allDataValues = [];
                
                addActivityLog(`Fetching data for ${periods.length} periods and ${orgUnits.length} org units...`);
                
                for (const period of periods) {
                    const url = `${state.config.instanceUrl}/api/dataValueSets.json?dataElement=${dataElementIds}&orgUnit=${orgUnitIds}&period=${period}`;
                    const response = await fetchWithAuth(url);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.dataValues) {
                            allDataValues = allDataValues.concat(data.dataValues);
                        }
                    }
                }
                
                state.currentData = allDataValues;
                processDataValues(allDataValues);
                updateLastUpdated();
                addActivityLog(`Successfully loaded ${allDataValues.length} data values`);
                showNotification('Data loaded successfully!', 'success');
            } catch (error) {
                console.error('Error fetching data:', error);
                addActivityLog(`Error: ${error.message}`);
                showNotification(`Failed to fetch data: ${error.message}`, 'error');
            } finally {
                if (refreshBtn) {
                    refreshBtn.classList.remove('loading');
                    refreshBtn.disabled = false;
                }
            }
        }

        function resetFilters() {
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.options[0].selected = true;
            for (let i = 1; i < yearSelect.options.length; i++) {
                yearSelect.options[i].selected = false;
            }
            
            const monthSelect = document.getElementById('monthFilter');
            monthSelect.options[0].selected = true;
            for (let i = 1; i < monthSelect.options.length; i++) {
                monthSelect.options[i].selected = false;
            }
            
            for (let level = 1; level <= 4; level++) {
                const select = document.getElementById(`level${level}Filter`);
                select.options[0].selected = true;
                for (let i = 1; i < select.options.length; i++) {
                    select.options[i].selected = false;
                }
            }
            
            showNotification('Filters reset to defaults', 'info');
        }

        function processDataValues(dataValues) {
            const grouped = {};
            let totalTested = 0, positiveCount = 0, negativeCount = 0, inconclusiveCount = 0;
            let ageSum = 0, ageCount = 0, counselingCount = 0;
            const counselingTypes = { individual: 0, group: 0, couples: 0 };
            
            dataValues.forEach(dv => {
                const key = `${dv.orgUnit}_${dv.period}`;
                if (!grouped[key]) {
                    grouped[key] = { orgUnit: dv.orgUnit, period: dv.period, clientsTested: 0, positive: 0, negative: 0, inconclusive: 0, ages: [], counseling: [] };
                }
                if (dv.dataElement === DATA_ELEMENTS.clientsTested) {
                    const count = parseInt(dv.value) || 0;
                    grouped[key].clientsTested += count;
                    totalTested += count;
                }
                if (dv.dataElement === DATA_ELEMENTS.testResult) {
                    if (dv.value === OPTIONS.positive) { grouped[key].positive++; positiveCount++; }
                    else if (dv.value === OPTIONS.negative) { grouped[key].negative++; negativeCount++; }
                    else if (dv.value === OPTIONS.inconclusive) { grouped[key].inconclusive++; inconclusiveCount++; }
                }
                if (dv.dataElement === DATA_ELEMENTS.clientAge) {
                    const age = parseInt(dv.value);
                    if (!isNaN(age)) { grouped[key].ages.push(age); ageSum += age; ageCount++; }
                }
                if (dv.dataElement === DATA_ELEMENTS.counselingType) {
                    counselingCount++;
                    grouped[key].counseling.push(dv.value);
                    if (dv.value === OPTIONS.individual) counselingTypes.individual++;
                    else if (dv.value === OPTIONS.group) counselingTypes.group++;
                    else if (dv.value === OPTIONS.couples) counselingTypes.couples++;
                }
            });
            
            document.getElementById('totalTested').textContent = totalTested.toLocaleString();
            document.getElementById('positiveCount').textContent = positiveCount.toLocaleString();
            document.getElementById('negativeCount').textContent = negativeCount.toLocaleString();
            document.getElementById('inconclusiveCount').textContent = inconclusiveCount.toLocaleString();
            document.getElementById('avgAge').textContent = ageCount > 0 ? Math.round(ageSum / ageCount) : '--';
            document.getElementById('counselingTotal').textContent = counselingCount.toLocaleString();
            
            updateDataTable(grouped);
            updateResultsChart(positiveCount, negativeCount, inconclusiveCount);
            updateCounselingChart(counselingTypes);
            updateTrendChart(grouped);
        }

        async function updateDataTable(grouped) {
            const tableBody = document.getElementById('tableBody');
            if (!tableBody) return;
            const orgUnitIds = [...new Set(Object.values(grouped).map(g => g.orgUnit))];
            const orgUnitNames = await fetchOrgUnitNames(orgUnitIds);
            tableBody.innerHTML = '';
            if (Object.keys(grouped).length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" class="loading-cell">No data available for selected filters</td>';
                tableBody.appendChild(row);
                return;
            }
            Object.values(grouped).forEach(data => {
                const row = document.createElement('tr');
                const avgAge = data.ages.length > 0 ? Math.round(data.ages.reduce((a, b) => a + b, 0) / data.ages.length) : '--';
                row.innerHTML = `<td>${orgUnitNames[data.orgUnit] || data.orgUnit}</td><td>${formatPeriod(data.period)}</td><td>${data.clientsTested}</td><td class="positive-cell">${data.positive}</td><td class="negative-cell">${data.negative}</td><td class="inconclusive-cell">${data.inconclusive}</td><td>${avgAge}</td><td>${data.counseling.length}</td>`;
                tableBody.appendChild(row);
            });
        }

        async function fetchOrgUnitNames(orgUnitIds) {
            if (orgUnitIds.length === 0) return {};
            try {
                const url = `${state.config.instanceUrl}/api/organisationUnits.json?filter=id:in:[${orgUnitIds.join(',')}]&fields=id,displayName&paging=false`;
                const response = await fetchWithAuth(url);
                if (response.ok) {
                    const data = await response.json();
                    const names = {};
                    data.organisationUnits.forEach(ou => { names[ou.id] = ou.displayName; });
                    return names;
                }
            } catch (error) {
                console.error('Error fetching org unit names:', error);
            }
            return {};
        }

        function formatPeriod(period) {
            const year = period.substring(0, 4);
            const month = period.substring(4, 6);
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${monthNames[parseInt(month) - 1]} ${year}`;
        }

        function updateResultsChart(positive, negative, inconclusive) {
            const ctx = document.getElementById('resultsChart');
            if (!ctx) return;
            if (state.charts.results) state.charts.results.destroy();
            state.charts.results = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Negative', 'Inconclusive'],
                    datasets: [{ data: [positive, negative, inconclusive], backgroundColor: ['rgba(220, 53, 69, 0.8)', 'rgba(46, 160, 67, 0.8)', 'rgba(255, 193, 7, 0.8)'], borderColor: ['rgba(220, 53, 69, 1)', 'rgba(46, 160, 67, 1)', 'rgba(255, 193, 7, 1)'], borderWidth: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function updateCounselingChart(counselingTypes) {
            const ctx = document.getElementById('counselingChart');
            if (!ctx) return;
            if (state.charts.counseling) state.charts.counseling.destroy();
            state.charts.counseling = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Individual', 'Group', 'Couples'],
                    datasets: [{ label: 'Sessions', data: [counselingTypes.individual, counselingTypes.group, counselingTypes.couples], backgroundColor: ['rgba(44, 102, 147, 0.8)', 'rgba(74, 144, 196, 0.8)', 'rgba(0, 188, 212, 0.8)'], borderColor: ['rgba(44, 102, 147, 1)', 'rgba(74, 144, 196, 1)', 'rgba(0, 188, 212, 1)'], borderWidth: 2 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function updateTrendChart(grouped) {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            if (state.charts.trend) state.charts.trend.destroy();
            const periodData = {};
            Object.values(grouped).forEach(data => {
                if (!periodData[data.period]) periodData[data.period] = { tested: 0, positive: 0, negative: 0 };
                periodData[data.period].tested += data.clientsTested;
                periodData[data.period].positive += data.positive;
                periodData[data.period].negative += data.negative;
            });
            const periods = Object.keys(periodData).sort();
            const labels = periods.map(p => formatPeriod(p));
            const testedData = periods.map(p => periodData[p].tested);
            const positiveData = periods.map(p => periodData[p].positive);
            const negativeData = periods.map(p => periodData[p].negative);
            state.charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Clients Tested', data: testedData, borderColor: 'rgba(44, 102, 147, 1)', backgroundColor: 'rgba(44, 102, 147, 0.1)', borderWidth: 3, tension: 0.4 },
                        { label: 'Positive Results', data: positiveData, borderColor: 'rgba(220, 53, 69, 1)', backgroundColor: 'rgba(220, 53, 69, 0.1)', borderWidth: 3, tension: 0.4 },
                        { label: 'Negative Results', data: negativeData, borderColor: 'rgba(46, 160, 67, 1)', backgroundColor: 'rgba(46, 160, 67, 0.1)', borderWidth: 3, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
            });
        }

        function exportTableToCSV() {
            const table = document.getElementById('dataTable');
            if (!table) return;
            let csv = [];
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const csvRow = [];
                cols.forEach(col => { csvRow.push('"' + col.textContent.replace(/"/g, '""') + '"'); });
                csv.push(csvRow.join(','));
            });
            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `hiv-testing-data-${timestamp}.csv`;
            link.click();
            showNotification('Data exported successfully!', 'success');
            addActivityLog('Data exported to CSV');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const instanceUrl = document.getElementById('instanceUrl').value.trim().replace(/\/$/, '');
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            if (!instanceUrl.startsWith('http://') && !instanceUrl.startsWith('https://')) {
                showNotification('URL must start with http:// or https://', 'error');
                return;
            }
            const submitBtn = e.target.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Connecting...';
            const config = { instanceUrl, username, password };
            try {
                showNotification('Connecting to DHIS2...', 'info');
                const testUrl = `${instanceUrl}/api/me`;
                const authHeader = 'Basic ' + btoa(`${username}:${password}`);
                const response = await fetch(testUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const userData = await response.json();
                    state.config = config;
                    state.isLoggedIn = true;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboardContent').classList.add('show');
                    const firstName = userData.firstName || '';
                    const surname = userData.surname || '';
                    const fullName = `${firstName} ${surname}`.trim() || 'User';
                    showNotification(`‚úÖ Connected successfully! Welcome ${fullName}`, 'success');
                    updateCurrentDate();
                    await loadOrganisationUnits();
                    
                    addActivityLog('Auto-loading data with default filters...');
                    setTimeout(() => {
                        applyFilters();
                    }, 500);
                } else if (response.status === 401) {
                    showNotification('‚ùå Invalid username or password', 'error');
                } else if (response.status === 403) {
                    showNotification('‚ùå Access forbidden', 'error');
                } else {
                    showNotification(`Authentication failed (${response.status})`, 'error');
                }
            } catch (error) {
                showNotification(`Connection failed: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Connect to Dashboard';
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            state.config = null;
            state.isLoggedIn = false;
            document.getElementById('dashboardContent').classList.remove('show');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginForm').reset();
            showNotification('Logged out successfully', 'info');
        });

        setInterval(updateCurrentDate, 60000);
    </script>
</body>
</html>
